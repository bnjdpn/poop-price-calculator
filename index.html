<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Poop Price Calculator 💩</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>💩</text></svg>">
    <style>
        :root{
            --bg:#0a0f1a; --bg2:#0c1324; --card:#0f1a33; --text:#e6edf3; --muted:#9aa4b2;
            --accent:#6ea8ff; --accent2:#22d3ee; --ring: rgba(110,168,255,.25);
            --radius:16px; --success:#22c55e; --warning:#f59e0b; --danger:#ef4444;
            --transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
        }
        [data-theme="light"]{
            --bg:#f8fafc; --bg2:#f1f5f9; --card:#ffffff; --text:#1e293b; --muted:#64748b;
            --accent:#3b82f6; --accent2:#06b6d4; --ring: rgba(59,130,246,.25);
        }
        *{box-sizing:border-box; transition:var(--transition)}
        html,body{height:100%}
        body{
            margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
            color:var(--text); overflow-x:hidden;
            background:
                    radial-gradient(1000px 700px at 10% -10%, #142955 0%, transparent 55%),
                    radial-gradient(900px 600px at 100% 0%, #0b2e38 0%, transparent 60%),
                    linear-gradient(180deg,var(--bg),var(--bg2));
            display:flex; align-items:flex-start; justify-content:center; padding:24px; gap:24px;
            min-height:100vh;
        }
        [data-theme="light"] body{
            background:
                    radial-gradient(1000px 700px at 10% -10%, #dbeafe 0%, transparent 55%),
                    radial-gradient(900px 600px at 100% 0%, #f0f9ff 0%, transparent 60%),
                    linear-gradient(180deg,var(--bg),var(--bg2));
        }
        .main-wrap{width:100%; max-width:560px}
        .side-wrap{width:100%; max-width:400px; position:sticky; top:24px}
        @media (max-width:1200px){
            body{flex-direction:column; align-items:center}
            .side-wrap{position:relative; top:0}
        }
        .header-controls{display:flex; justify-content:space-between; align-items:center; margin-bottom:24px}
        .theme-toggle{
            background:var(--card); border:1px solid rgba(255,255,255,.06); border-radius:12px;
            padding:8px 12px; cursor:pointer; display:flex; align-items:center; gap:8px;
            font-size:.9rem; color:var(--muted);
        }
        .theme-toggle:hover{background:rgba(255,255,255,.05)}
        h1{
            margin:0; text-align:center; font-size:clamp(22px,4vw,34px); font-weight:900;
            background:linear-gradient(90deg,var(--accent),var(--accent2));
            -webkit-background-clip:text; background-clip:text; color:transparent;
            text-shadow:0 0 30px rgba(110,168,255,.25); cursor:pointer;
        }
        .subtitle{margin:0 0 16px; text-align:center; color:var(--muted); font-size:.95rem}
        .card{
            background:rgba(15,26,51,.7); border:1px solid rgba(255,255,255,.06);
            border-radius:var(--radius); box-shadow:0 12px 40px rgba(0,0,0,.45);
            backdrop-filter: blur(6px); padding:18px; margin-bottom:20px;
        }
        [data-theme="light"] .card{
            background:var(--card); border:1px solid #e2e8f0;
            box-shadow:0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -2px rgba(0,0,0,.1);
        }
        .grid{display:grid; gap:12px}
        @media (min-width:640px){ .grid{grid-template-columns:1fr 1fr} }
        label{font-size:.9rem; color:var(--muted); display:block; margin-bottom:6px}
        input, select{
            width:100%; border-radius:12px; padding:.75rem .9rem; background:#0b152a;
            color:var(--text); border:1px solid rgba(148,163,184,.25); outline:none;
            font-size:.95rem;
        }
        [data-theme="light"] input, [data-theme="light"] select{
            background:#f8fafc; border:1px solid #cbd5e1;
        }
        input:focus, select:focus{border-color:var(--accent); box-shadow:0 0 0 4px var(--ring)}
        .input-group{position:relative}
        .input-suffix{position:absolute; right:12px; top:50%; transform:translateY(-50%);
                      color:var(--muted); font-size:.85rem; pointer-events:none}
        .extra-grid{display:grid; gap:12px}
        .extra-grid--split{grid-template-columns:repeat(auto-fit,minmax(150px,1fr))}
        .range-row{display:flex; align-items:center; gap:12px; padding:.7rem .9rem; border-radius:12px;
                   background:#0b152a; border:1px solid rgba(148,163,184,.25)}
        [data-theme="light"] .range-row{background:#f8fafc; border:1px solid #cbd5e1}
        .range-row input[type=range]{flex:1; accent-color:var(--accent); cursor:pointer}
        .range-value{min-width:48px; font-weight:600; color:var(--accent); text-align:right;
                     font-variant-numeric:tabular-nums}
        #modeExtras:empty{display:none}
        .full{grid-column:1/-1}
        .result{
            margin-top:14px; padding:18px; border-radius:12px; background:#0b152a;
            border:1px solid rgba(148,163,184,.2); text-align:center; position:relative;
            overflow:hidden;
        }
        [data-theme="light"] .result{background:#f8fafc; border:1px solid #cbd5e1}
        #result[data-tone="success"]{border-color:rgba(34,197,94,.45); box-shadow:0 12px 30px rgba(34,197,94,.12)}
        #result[data-tone="warning"]{border-color:rgba(245,158,11,.45); box-shadow:0 12px 30px rgba(245,158,11,.12)}
        #result[data-tone="danger"]{border-color:rgba(239,68,68,.45); box-shadow:0 12px 30px rgba(239,68,68,.15)}
        .price{font-size:clamp(26px,5vw,40px); font-weight:900; position:relative; z-index:2}
        .price-animation{position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) scale(0);
                        font-size:2rem; opacity:0; z-index:1; pointer-events:none}
        .price-animation.animate{animation:priceBoost 0.6s ease-out}
        @keyframes priceBoost{
            0%{transform:translate(-50%,-50%) scale(0); opacity:1}
            50%{transform:translate(-50%,-50%) scale(1.2); opacity:0.8}
            100%{transform:translate(-50%,-50%) scale(2); opacity:0}
        }
        .tag{display:inline-flex; gap:8px; align-items:center; padding:.4rem .7rem; border-radius:999px;
            background:#0e1a30; border:1px solid rgba(148,163,184,.25); color:var(--muted); font-size:.85rem;
            margin:4px 2px}
        [data-theme="light"] .tag{background:#f1f5f9; border:1px solid #cbd5e1}
        .footer{margin-top:8px; text-align:center; color:var(--muted); font-size:.8rem}
        .stats-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:12px}
        .stat-card{padding:12px; border-radius:12px; background:#0b152a; border:1px solid rgba(148,163,184,.1);
                   text-align:center}
        [data-theme="light"] .stat-card{background:#f8fafc; border:1px solid #e2e8f0}
        .stat-value{font-size:1.5rem; font-weight:700; color:var(--accent)}
        .stat-label{font-size:.75rem; color:var(--muted); margin-top:4px}
        .history-list{max-height:300px; overflow-y:auto}
        .history-item{padding:12px; border-radius:8px; background:#0b152a; margin-bottom:8px;
                      border:1px solid rgba(148,163,184,.1); cursor:pointer}
        [data-theme="light"] .history-item{background:#f8fafc; border:1px solid #e2e8f0}
        .history-item:hover{background:rgba(255,255,255,.02)}
        [data-theme="light"] .history-item:hover{background:#f1f5f9}
        .history-price{font-weight:600; color:var(--accent)}
        .history-details{font-size:.8rem; color:var(--muted); margin-top:4px}
        .btn{padding:8px 16px; border-radius:8px; border:none; cursor:pointer; font-size:.9rem;
             display:inline-flex; align-items:center; gap:8px; text-decoration:none}
        .btn-primary{background:var(--accent); color:white}
        .btn-secondary{background:var(--card); color:var(--text); border:1px solid rgba(255,255,255,.1)}
        [data-theme="light"] .btn-secondary{border:1px solid #e2e8f0}
        .btn:disabled{opacity:.45; cursor:not-allowed; transform:none}
        .btn:focus-visible{outline:2px solid var(--accent2); outline-offset:2px}
        .btn:not(:disabled):hover{opacity:.9; transform:translateY(-1px)}
        .btn-group{display:flex; gap:8px; flex-wrap:wrap; justify-content:center}
        .mode-selector{display:flex; background:#0b152a; border-radius:12px; padding:4px; margin-bottom:16px}
        [data-theme="light"] .mode-selector{background:#f1f5f9; border:1px solid #e2e8f0}
        .mode-btn{flex:1; padding:8px 12px; border-radius:8px; border:none; background:transparent;
                  color:var(--muted); cursor:pointer; font-size:.85rem}
        .mode-btn.active{background:var(--accent); color:white}
        .easter-egg{position:fixed; pointer-events:none; z-index:1000; font-size:2rem}
        .shake{animation:shake 0.5s ease-in-out}
        @keyframes shake{
            0%,100%{transform:translateX(0)}
            25%{transform:translateX(-5px)}
            75%{transform:translateX(5px)}
        }
        .pulse{animation:pulse 2s infinite}
        @keyframes pulse{
            0%,100%{opacity:1}
            50%{opacity:.5}
        }
        .timer-card h3{margin:0 0 12px; display:flex; align-items:center; gap:8px; font-size:1.05rem}
        .timer-display{font-size:2.4rem; font-weight:700; text-align:center; letter-spacing:1px; margin-bottom:12px}
        .timer-meta{display:flex; justify-content:space-between; gap:12px; margin-bottom:12px; font-size:.82rem; color:var(--muted)}
        .timer-meta span{display:flex; align-items:center; gap:6px}
        .timer-controls{justify-content:center}
        .timer-controls .btn{min-width:110px}
        .timer-running{color:var(--accent2)}
        .info-note{margin-top:12px; font-size:.8rem; color:var(--muted); text-align:center}
        .insights-list{display:flex; flex-direction:column; gap:10px; font-variant-numeric:tabular-nums}
        .insight-item{display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-radius:12px; background:rgba(148,163,184,.12)}
        [data-theme="light"] .insight-item{background:#e2e8f0}
        .insight-label{font-size:.85rem; color:var(--muted)}
        .insight-value{font-weight:600}
        .sparkline{width:100%; height:80px; margin-top:16px}
        .sparkline rect{fill:rgba(148,163,184,.1)}
        [data-theme="light"] .sparkline rect{fill:#e2e8f0}
        .sparkline path{fill:none; stroke:var(--accent2); stroke-width:2; stroke-linecap:round; stroke-linejoin:round}
        .toast-container{position:fixed; bottom:24px; right:24px; display:flex; flex-direction:column; gap:10px; z-index:2000; pointer-events:none}
        .toast{background:var(--card); color:var(--text); border:1px solid rgba(148,163,184,.2); padding:12px 16px; border-radius:12px;
               box-shadow:0 12px 30px rgba(0,0,0,.35); opacity:.95; transform:translateY(0); transition:opacity .3s ease, transform .3s ease;
               pointer-events:auto}
        [data-theme="light"] .toast{background:#ffffff; border:1px solid #cbd5e1}
        .toast.hide{opacity:0; transform:translateY(12px)}
        .achievements{display:grid; gap:10px}
        .achievement{padding:10px 12px; border-radius:12px; background:rgba(148,163,184,.12); display:flex; justify-content:space-between; align-items:center}
        [data-theme="light"] .achievement{background:#e2e8f0}
        .achievement.locked{opacity:.55}
        .achievement span{display:flex; gap:6px; align-items:center}
        @media (max-width:640px){
            body{padding:16px}
            .header-controls{flex-direction:column; gap:12px}
        }
    </style>
</head>
<body data-theme="dark">
<div class="main-wrap">
    <div class="header-controls">
        <h1 id="title">Poop Price Calculator</h1>
        <button class="theme-toggle" id="themeToggle">
            <span id="themeIcon">🌙</span>
            <span id="themeText">Mode sombre</span>
        </button>
    </div>
    <p class="subtitle">💩 + 🚽 → prix instantané (trajet aller&nbsp;+&nbsp;retour inclus)</p>

    <div class="card">
        <div class="mode-selector">
            <button class="mode-btn active" data-mode="basic">💰 Basic</button>
            <button class="mode-btn" data-mode="advanced">📊 Avancé</button>
            <button class="mode-btn" data-mode="enterprise">🏢 Enterprise</button>
        </div>

        <div class="grid" id="inputGrid">
            <div>
                <label for="tj">Taux journalier (€/jour)</label>
                <div class="input-group">
                    <input id="tj" type="number" min="0" step="1" inputmode="numeric" />
                    <span class="input-suffix">€</span>
                </div>
            </div>
            <div>
                <label for="activeH">Temps facturable (heures)</label>
                <div class="input-group">
                    <input id="activeH" type="number" min="0.25" step="0.25" />
                    <span class="input-suffix">h</span>
                </div>
            </div>

            <div>
                <label for="poopMin">Durée du 💩 (minutes)</label>
                <div class="input-group">
                    <input id="poopMin" type="number" min="0" step="0.5" inputmode="decimal" />
                    <span class="input-suffix">min</span>
                </div>
            </div>
            <div>
                <label for="oneWaySec">Trajet 🚶→🚽 (secondes, aller)</label>
                <div class="input-group">
                    <input id="oneWaySec" type="number" min="0" step="1" inputmode="numeric" />
                    <span class="input-suffix">sec</span>
                </div>
            </div>

            <div>
                <label for="frequency">Fréquence quotidienne</label>
                <div class="input-group">
                    <input id="frequency" type="number" min="0" step="0.5" inputmode="decimal" />
                    <span class="input-suffix">/jour</span>
                </div>
            </div>

            <div class="full" id="modeExtras" aria-live="polite"></div>

            <div class="full result" id="result">
                <div class="price-animation" id="priceAnimation">💸</div>
                <div class="price" id="price">—</div>
                <div>
                    <div class="tag">Inclut le trajet aller&nbsp;+&nbsp;retour</div>
                    <div class="tag" id="efficiencyTag">—</div>
                </div>
            </div>
        </div>

        <div class="btn-group">
            <button class="btn btn-secondary" id="saveBtn">💾 Sauvegarder</button>
            <button class="btn btn-secondary" id="shareBtn">📤 Partager</button>
            <button class="btn btn-secondary" id="resetBtn">🔄 Reset</button>
        </div>

        <div class="footer">Tout se met à jour au fil de la saisie. Valeurs par défaut appliquées.</div>
    </div>

    <div class="card timer-card">
        <h3>🕒 Minuteur de session</h3>
        <div class="timer-display" id="timerDisplay">00:00</div>
        <div class="timer-meta">
            <span id="timerStatus">En attente</span>
            <span id="timerAutoFill">Remplit automatiquement la durée</span>
        </div>
        <div class="btn-group timer-controls">
            <button class="btn btn-primary" id="timerStart">▶️ Lancer</button>
            <button class="btn btn-secondary" id="timerPause">⏸️ Pause</button>
            <button class="btn btn-secondary" id="timerApply">✅ Appliquer</button>
        </div>
        <div class="info-note">Le minuteur enregistre la durée du 💩 et met à jour le champ correspondant.</div>
    </div>
</div>

<div class="side-wrap">
    <div class="card">
        <h3 style="margin:0 0 16px; color:var(--accent)">📈 Statistiques</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalCalculations">0</div>
                <div class="stat-label">Calculs</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgCost">0€</div>
                <div class="stat-label">Coût moyen</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalTime">0min</div>
                <div class="stat-label">Temps total</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="dailyLoss">0€</div>
                <div class="stat-label">Perte/jour</div>
            </div>
        </div>
    </div>

    <div class="card">
        <h3 style="margin:0 0 16px; color:var(--accent)">💡 Insights</h3>
        <div class="insights-list">
            <div class="insight-item">
                <span class="insight-label">Impact quotidien</span>
                <span class="insight-value" id="insightDaily">—</span>
            </div>
            <div class="insight-item">
                <span class="insight-label">Impact mensuel (22j)</span>
                <span class="insight-value" id="insightMonthly">—</span>
            </div>
            <div class="insight-item">
                <span class="insight-label">Impact annuel</span>
                <span class="insight-value" id="insightYearly">—</span>
            </div>
            <div class="insight-item">
                <span class="insight-label">Temps perdu / jour</span>
                <span class="insight-value" id="insightTime">—</span>
            </div>
            <div class="insight-item">
                <span class="insight-label">Équivalent cafés</span>
                <span class="insight-value" id="insightCoffees">—</span>
            </div>
        </div>
        <svg class="sparkline" id="historySparkline" viewBox="0 0 100 40" preserveAspectRatio="none" role="img" aria-label="Historique des coûts (derniers calculs)">
            <rect x="0" y="0" width="100" height="40" rx="12" ry="12"></rect>
            <path id="sparklinePath" d="" opacity="0"></path>
        </svg>
    </div>

    <div class="card">
        <h3 style="margin:0 0 16px; color:var(--accent)">📝 Historique</h3>
        <div class="history-list" id="historyList">
            <div style="text-align:center; color:var(--muted); font-style:italic">Aucun calcul encore</div>
        </div>
        <div class="btn-group" style="margin-top:12px">
            <button class="btn btn-secondary" id="exportBtn">📊 Exporter CSV</button>
            <button class="btn btn-secondary" id="clearHistoryBtn">🗑️ Vider</button>
        </div>
    </div>
    <div class="card">
        <h3 style="margin:0 0 16px; color:var(--accent)">🏆 Succès</h3>
        <div class="achievements" id="achievementsList">
            <div class="achievement locked" data-key="first">
                <span>🥉 Premier calcul</span>
                <span class="achievement-status">🔒</span>
            </div>
            <div class="achievement locked" data-key="saver">
                <span>🥈 Fan de stats</span>
                <span class="achievement-status">🔒</span>
            </div>
            <div class="achievement locked" data-key="highroller">
                <span>🥇 Gros poisson</span>
                <span class="achievement-status">🔒</span>
            </div>
        </div>
    </div>
    <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>
<script>
    (() => {
        const DEFAULTS = {
            basic: { tj: 600, activeH: 7.5, poopMin: 6, oneWaySec: 30, frequency: 2.5 },
            advanced: { tj: 800, activeH: 8, poopMin: 8, oneWaySec: 45, productivity: 85, urgency: 'normal', frequency: 3 },
            enterprise: { tj: 1200, activeH: 9, poopMin: 10, oneWaySec: 60, productivity: 90, urgency: 'normal', teamSize: 5, meetingCost: 0, frequency: 4 }
        };
        const MODE_LABELS = { basic: 'Basic', advanced: 'Avancé', enterprise: 'Enterprise' };

        // State
        let currentMode = 'basic';
        const DEFAULT_STATS = { calculations: 0, totalCost: 0, totalTime: 0 };

        const readStorage = (key, fallback) => {
            try {
                const raw = localStorage.getItem(key);
                if (!raw) return JSON.parse(JSON.stringify(fallback));
                const parsed = JSON.parse(raw);
                if (Array.isArray(fallback)) return Array.isArray(parsed) ? parsed : [];
                return typeof parsed === 'object' && parsed ? parsed : JSON.parse(JSON.stringify(fallback));
            } catch {
                return JSON.parse(JSON.stringify(fallback));
            }
        };

        const storedStats = readStorage('poopStats', DEFAULT_STATS);
        let stats = { ...DEFAULT_STATS, ...storedStats };
        stats.calculations = Number(stats.calculations) || 0;
        stats.totalCost = Number(stats.totalCost) || 0;
        stats.totalTime = Number(stats.totalTime) || 0;
        const storedHistory = readStorage('poopHistory', []);
        let history = Array.isArray(storedHistory) ? storedHistory : [];
        let theme = localStorage.getItem('poopTheme') || 'dark';
        const storedAchievementsList = readStorage('poopAchievements', []);
        const unlockedAchievements = new Set(Array.isArray(storedAchievementsList) ? storedAchievementsList : []);

        // Elements
        const el = id => document.getElementById(id);
        const body = document.body;
        const tj = el('tj'), activeH = el('activeH'), poopMin = el('poopMin'), oneWaySec = el('oneWaySec'), frequency = el('frequency');
        const price = el('price'), priceAnimation = el('priceAnimation'), efficiencyTag = el('efficiencyTag');
        const resultCard = el('result');
        const title = el('title'), themeToggle = el('themeToggle'), themeIcon = el('themeIcon'), themeText = el('themeText');
        const inputGrid = el('inputGrid'), historyList = el('historyList'), modeExtras = el('modeExtras');
        const totalCalculations = el('totalCalculations'), avgCost = el('avgCost'), totalTime = el('totalTime'), dailyLoss = el('dailyLoss');
        const insightsEls = {
            daily: el('insightDaily'),
            monthly: el('insightMonthly'),
            yearly: el('insightYearly'),
            time: el('insightTime'),
            coffees: el('insightCoffees')
        };
        const sparklinePath = document.getElementById('sparklinePath');
        const timerDisplay = el('timerDisplay'), timerStatus = el('timerStatus'), timerAutoFill = el('timerAutoFill');
        const timerStartBtn = el('timerStart'), timerPauseBtn = el('timerPause'), timerApplyBtn = el('timerApply');
        const toastContainer = el('toastContainer');
        const achievementNodes = Array.from(document.querySelectorAll('.achievement'));
        const achievementMap = achievementNodes.reduce((acc, node) => {
            acc[node.dataset.key] = node;
            return acc;
        }, {});
        const timerState = { running: false, start: 0, elapsed: 0, interval: null };
        const timerAutoFillBase = timerAutoFill ? timerAutoFill.textContent : '';

        // Utilities
        const fmtMoney = (n) => new Intl.NumberFormat('fr-FR', {style:'currency', currency:'EUR', minimumFractionDigits:2, maximumFractionDigits:2}).format(n);
        const fmtTime = (min) => min > 60 ? `${Math.floor(min/60)}h ${Math.round(min%60)}min` : `${Math.round(min)}min`;
        const randomEmoji = () => ['💸','💰','🤑','💵','💴','💶','💷'][Math.floor(Math.random()*7)];
        const formatFrequency = (value) => {
            const num = Number(value);
            return Number.isFinite(num) && num > 0 ? `${num.toLocaleString('fr-FR', { maximumFractionDigits: 1 })}/j` : '';
        };
        const playSound = (freq, duration) => {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                osc.frequency.setValueAtTime(freq, ctx.currentTime);
                osc.connect(ctx.destination);
                osc.start(); osc.stop(ctx.currentTime + duration/1000);
            } catch{}
        };

        // Theme management
        function toggleTheme() {
            theme = theme === 'dark' ? 'light' : 'dark';
            body.dataset.theme = theme;
            themeIcon.textContent = theme === 'dark' ? '🌙' : '☀️';
            themeText.textContent = theme === 'dark' ? 'Mode sombre' : 'Mode clair';
            localStorage.setItem('poopTheme', theme);
        }

        // Mode management
        function switchMode(newMode) {
            currentMode = newMode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-mode="${newMode}"]`).classList.add('active');

            // Update inputs based on mode
            updateInputsForMode(newMode);
            loadDefaults();
        }

        function updateInputsForMode(mode) {
            modeExtras.innerHTML = '';
            modeExtras.dataset.mode = mode;

            if (mode === 'advanced' || mode === 'enterprise') {
                const advancedMarkup = `
                    <div class="extra-grid">
                        <div>
                            <label for="productivity">Productivité habituelle (%)</label>
                            <div class="range-row">
                                <input id="productivity" type="range" min="50" max="100" step="5" />
                                <span class="range-value" id="productivityValue">85%</span>
                            </div>
                        </div>
                        <div>
                            <label for="urgency">Urgence du besoin</label>
                            <select id="urgency">
                                <option value="low">😌 Tranquille</option>
                                <option value="normal" selected>😐 Normal</option>
                                <option value="high">😰 Urgent</option>
                                <option value="emergency">🚨 URGENCE!</option>
                            </select>
                        </div>
                    </div>
                `;

                const enterpriseMarkup = `
                    <div class="extra-grid extra-grid--split">
                        <div>
                            <label for="teamSize">Taille équipe</label>
                            <div class="input-group">
                                <input id="teamSize" type="number" min="1" step="1" />
                                <span class="input-suffix">pers.</span>
                            </div>
                        </div>
                        <div>
                            <label for="meetingCost">Coût/h réunion</label>
                            <div class="input-group">
                                <input id="meetingCost" type="number" min="0" step="50" />
                                <span class="input-suffix">€</span>
                            </div>
                        </div>
                    </div>
                `;

                modeExtras.innerHTML = advancedMarkup + (mode === 'enterprise' ? enterpriseMarkup : '');
            }

            attachModeExtrasListeners();
        }

        function updateProductivityDisplay() {
            const slider = el('productivity');
            const label = el('productivityValue');
            if (slider && label) label.textContent = `${slider.value}%`;
        }

        function attachModeExtrasListeners() {
            const productivitySlider = el('productivity');

            if (productivitySlider) {
                updateProductivityDisplay();
                productivitySlider.addEventListener('input', () => {
                    updateProductivityDisplay();
                    compute();
                });
            }

            ['urgency', 'teamSize', 'meetingCost'].forEach(id => {
                const control = el(id);
                if (control) control.addEventListener('input', compute);
            });
        }

        // Enhanced computation
        function compute() {
            const TJ = Math.max(0, Number(tj.value || 0));
            const H = Math.max(0.0001, Number(activeH.value || 0));
            const poopM = Math.max(0, Number(poopMin.value || 0));
            const oneS = Math.max(0, Number(oneWaySec.value || 0));
            const freq = Math.max(0, Number(frequency?.value || 0));

            const activeMin = H * 60;
            const perMin = TJ / activeMin;
            const totalMinutes = poopM + (2 * oneS) / 60;
            let cost = totalMinutes * perMin;

            // Apply mode-specific calculations
            if (currentMode === 'advanced' || currentMode === 'enterprise') {
                const productivity = Number(el('productivity')?.value || 85) / 100;
                const urgency = el('urgency')?.value || 'normal';

                // Urgency multipliers
                const urgencyMultipliers = { low: 0.8, normal: 1, high: 1.3, emergency: 2 };
                cost *= urgencyMultipliers[urgency] || 1;

                // Productivity adjustment
                cost *= (2 - productivity); // Lower productivity = higher relative cost

                if (currentMode === 'enterprise') {
                    const teamSize = Number(el('teamSize')?.value || 1);
                    const meetingCost = Number(el('meetingCost')?.value || 0);

                    // Team impact (if blocking others)
                    if (teamSize > 1) cost *= 1 + (teamSize - 1) * 0.1;

                    // Meeting opportunity cost
                    if (meetingCost > 0) cost += (meetingCost / 60) * totalMinutes;
                }
            }

            // Update display
            const oldPrice = price.textContent;
            price.textContent = fmtMoney(cost);

            // Efficiency rating
            const efficiency = cost < 2 ? '🟢 Efficace' : cost < 5 ? '🟡 Moyen' : '🔴 Coûteux';
            efficiencyTag.textContent = efficiency;
            if (resultCard) {
                const tone = cost < 2 ? 'success' : cost < 5 ? 'warning' : 'danger';
                resultCard.dataset.tone = tone;
            }

            // Animation on change
            if (oldPrice !== '—' && oldPrice !== price.textContent) {
                priceAnimation.textContent = randomEmoji();
                priceAnimation.classList.add('animate');
                setTimeout(() => priceAnimation.classList.remove('animate'), 600);

                if (cost > 10) playSound(200, 100);
            }

            const dailyCost = cost * freq;
            const monthlyCost = dailyCost * 22;
            const yearlyCost = dailyCost * 220;
            const dailyMinutes = totalMinutes * freq;

            const result = { cost, totalMinutes, efficiency, freq, dailyCost, monthlyCost, yearlyCost, dailyMinutes };
            updateInsights(result);

            return result;
        }

        // History management
        function saveCalculation() {
            const calc = compute();
            const timestamp = new Date().toISOString();
            const inputs = {
                tj: tj.value,
                activeH: activeH.value,
                poopMin: poopMin.value,
                oneWaySec: oneWaySec.value,
                frequency: frequency.value
            };

            ['productivity', 'urgency', 'teamSize', 'meetingCost'].forEach(id => {
                const node = el(id);
                if (node) inputs[id] = node.value;
            });

            const entry = {
                timestamp,
                cost: calc.cost,
                time: calc.totalMinutes,
                mode: currentMode,
                inputs
            };

            history.unshift(entry);
            if (history.length > 50) history = history.slice(0, 50); // Keep last 50

            stats.calculations++;
            stats.totalCost += calc.cost;
            stats.totalTime += calc.totalMinutes;

            localStorage.setItem('poopHistory', JSON.stringify(history));
            localStorage.setItem('poopStats', JSON.stringify(stats));

            updateStats();
            updateHistory();
            evaluateAchievements();

            // Success animation
            title.classList.add('pulse');
            setTimeout(() => title.classList.remove('pulse'), 2000);
        }

        function updateStats() {
            totalCalculations.textContent = stats.calculations;
            avgCost.textContent = stats.calculations > 0 ? fmtMoney(stats.totalCost / stats.calculations) : fmtMoney(0);
            totalTime.textContent = fmtTime(stats.totalTime);

            // Daily loss estimation (assuming 3 times per day)
            const dailyCost = stats.calculations > 0 ? (stats.totalCost / stats.calculations) * 3 : 0;
            dailyLoss.textContent = fmtMoney(dailyCost);
        }

        function updateInsights(calc) {
            if (!insightsEls.daily) return;

            if (calc.freq > 0) {
                insightsEls.daily.textContent = fmtMoney(calc.dailyCost);
                insightsEls.monthly.textContent = fmtMoney(calc.monthlyCost);
                insightsEls.yearly.textContent = fmtMoney(calc.yearlyCost);
                insightsEls.time.textContent = fmtTime(calc.dailyMinutes);

                const coffeePrice = 2.5;
                const coffees = calc.dailyCost / coffeePrice;
                const coffeeText = coffees >= 10 ? `${Math.round(coffees)} ☕` : `${coffees.toFixed(1)} ☕`;
                insightsEls.coffees.textContent = coffeeText;
            } else {
                insightsEls.daily.textContent = '—';
                insightsEls.monthly.textContent = '—';
                insightsEls.yearly.textContent = '—';
                insightsEls.time.textContent = '—';
                insightsEls.coffees.textContent = '—';
            }
        }

        function updateHistory() {
            if (history.length === 0) {
                historyList.innerHTML = '<div style="text-align:center; color:var(--muted); font-style:italic">Aucun calcul encore</div>';
                updateSparkline();
                return;
            }

            historyList.innerHTML = history.slice(0, 10).map(entry => {
                const freqLabel = formatFrequency(entry.inputs?.frequency);
                const costValue = Number(entry.cost) || 0;
                return `
                <div class="history-item" onclick="loadFromHistory('${entry.timestamp}')">
                    <div class="history-price">${fmtMoney(costValue)}</div>
                    <div class="history-details">
                        ${new Date(entry.timestamp).toLocaleDateString('fr')} • ${fmtTime(entry.time)} • ${MODE_LABELS[entry.mode] || entry.mode}${freqLabel ? ` • ${freqLabel}` : ''}
                    </div>
                </div>
            `;
            }).join('');

            updateSparkline();
        }

        function updateSparkline() {
            if (!sparklinePath) return;

            const recent = history.slice(0, 12).map(entry => Number(entry.cost) || 0).reverse();
            if (recent.length === 0) {
                sparklinePath.setAttribute('d', '');
                sparklinePath.setAttribute('opacity', '0');
                return;
            }

            const height = 40;
            const width = 100;

            if (recent.length === 1) {
                const midY = height / 2;
                sparklinePath.setAttribute('d', `M0,${midY} L${width},${midY}`);
                sparklinePath.setAttribute('opacity', '0.35');
                return;
            }

            const max = Math.max(...recent);
            const min = Math.min(...recent);
            const range = max - min || Math.max(max, 1);
            const step = width / (recent.length - 1);

            const path = recent.map((cost, index) => {
                const normalized = range === 0 ? 0.5 : (cost - min) / range;
                const y = height - (normalized * (height - 6)) - 3;
                const x = index * step;
                return `${index === 0 ? 'M' : 'L'}${x.toFixed(2)},${y.toFixed(2)}`;
            }).join(' ');

            sparklinePath.setAttribute('d', path);
            sparklinePath.setAttribute('opacity', '1');
        }

        function showToast(message) {
            if (!toastContainer) return;
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            toastContainer.appendChild(toast);

            while (toastContainer.childElementCount > 4) {
                toastContainer.firstElementChild?.remove();
            }

            setTimeout(() => toast.classList.add('hide'), 3500);
            setTimeout(() => toast.remove(), 4100);
        }

        function setAchievementState(key, unlocked) {
            const node = achievementMap[key];
            if (!node) return;
            node.classList.toggle('locked', !unlocked);
            const statusEl = node.querySelector('.achievement-status');
            if (statusEl) statusEl.textContent = unlocked ? '✅' : '🔒';
        }

        function highlightAchievement(key) {
            const node = achievementMap[key];
            if (!node) return;
            node.classList.add('pulse');
            setTimeout(() => node.classList.remove('pulse'), 1600);
            const label = node.querySelector('span')?.textContent?.trim() || key;
            showToast(`Succès débloqué : ${label}`);
        }

        function evaluateAchievements({ silent = false } = {}) {
            const highestCost = history.reduce((max, entry) => Math.max(max, Number(entry.cost) || 0), 0);
            const conditions = {
                first: stats.calculations > 0,
                saver: history.length >= 5 || stats.totalTime >= 120,
                highroller: highestCost >= 50
            };

            let updated = false;
            Object.entries(conditions).forEach(([key, unlocked]) => {
                if (unlocked && !unlockedAchievements.has(key)) {
                    unlockedAchievements.add(key);
                    updated = true;
                    if (!silent) highlightAchievement(key);
                }
                setAchievementState(key, unlockedAchievements.has(key));
            });

            if (updated) {
                localStorage.setItem('poopAchievements', JSON.stringify(Array.from(unlockedAchievements)));
            }
        }

        function getTimerElapsed() {
            return timerState.running ? timerState.elapsed + (Date.now() - timerState.start) : timerState.elapsed;
        }

        function formatTimer(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function updateTimerUI(statusText) {
            if (!timerDisplay) return;
            const elapsed = getTimerElapsed();
            timerDisplay.textContent = formatTimer(elapsed);
            if (statusText && timerStatus) timerStatus.textContent = statusText;
            timerStatus?.classList.toggle('timer-running', timerState.running);

            if (timerStartBtn) {
                timerStartBtn.disabled = timerState.running;
                timerStartBtn.textContent = !timerState.running && timerState.elapsed > 0 ? '🔁 Reprendre' : '▶️ Lancer';
            }
            if (timerPauseBtn) timerPauseBtn.disabled = !timerState.running;
            if (timerApplyBtn) timerApplyBtn.disabled = elapsed < 5000;
        }

        function startTimer() {
            if (!timerDisplay || timerState.running) return;
            timerState.running = true;
            timerState.start = Date.now();
            timerState.interval = setInterval(() => updateTimerUI(), 250);
            updateTimerUI('En cours…');
        }

        function pauseTimer(manual = true) {
            if (!timerState.running) return;
            timerState.elapsed += Date.now() - timerState.start;
            timerState.running = false;
            if (timerState.interval) {
                clearInterval(timerState.interval);
                timerState.interval = null;
            }
            updateTimerUI(manual ? 'En pause' : undefined);
        }

        function resetTimer(status = 'En attente') {
            if (timerState.interval) {
                clearInterval(timerState.interval);
                timerState.interval = null;
            }
            timerState.running = false;
            timerState.start = 0;
            timerState.elapsed = 0;
            updateTimerUI(status);
            if (timerAutoFill) timerAutoFill.textContent = timerAutoFillBase;
        }

        function applyTimer() {
            const elapsed = getTimerElapsed();
            if (elapsed < 5000) {
                updateTimerUI('Session trop courte');
                setTimeout(() => updateTimerUI('En attente'), 1200);
                return;
            }

            pauseTimer(false);
            const minutes = elapsed / 60000;
            const rounded = Math.max(0.5, Number(minutes.toFixed(1)));
            poopMin.value = rounded;
            if (timerAutoFill) timerAutoFill.textContent = `Dernière durée enregistrée : ${rounded} min`;
            compute();
            saveCalculation();
            showToast(`Durée appliquée (${rounded} min)`);
            resetTimer('En attente');
        }

        function loadFromHistory(timestamp) {
            const entry = history.find(h => h.timestamp === timestamp);
            if (!entry) return;

            if (entry.mode !== currentMode) switchMode(entry.mode);

            tj.value = entry.inputs.tj;
            activeH.value = entry.inputs.activeH;
            poopMin.value = entry.inputs.poopMin;
            oneWaySec.value = entry.inputs.oneWaySec;
            if (entry.inputs.frequency !== undefined) frequency.value = entry.inputs.frequency;

            ['productivity', 'urgency', 'teamSize', 'meetingCost'].forEach(id => {
                if (entry.inputs[id] !== undefined && el(id)) {
                    el(id).value = entry.inputs[id];
                }
            });
            updateProductivityDisplay();

            compute();
        }

        // Export functionality
        function exportToCSV() {
            const csv = [
                'Date,Coût,Temps (min),Mode,TJ,Heures,Durée poop,Trajet,Fréquence,Productivité,Urgence,Équipe,Coût réunion',
                ...history.map(h => {
                    const inputs = h.inputs || {};
                    return [
                        new Date(h.timestamp).toLocaleDateString('fr'),
                        Number(h.cost || 0).toFixed(2),
                        Number(h.time || 0).toFixed(1),
                        h.mode,
                        inputs.tj ?? '',
                        inputs.activeH ?? '',
                        inputs.poopMin ?? '',
                        inputs.oneWaySec ?? '',
                        inputs.frequency ?? '',
                        inputs.productivity ?? '',
                        inputs.urgency ?? '',
                        inputs.teamSize ?? '',
                        inputs.meetingCost ?? ''
                    ].join(',');
                })
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `poop-calculator-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Share functionality
        async function shareResults() {
            const calc = compute();
            const freqInfo = calc.freq > 0 ? ` (${calc.freq.toLocaleString('fr-FR')}x/jour)` : '';
            const text = `J'ai calculé que mon 💩 me coûte ${fmtMoney(calc.cost)}${freqInfo} ! Calculez le vôtre sur Poop Price Calculator 💩`;

            if (navigator.share) {
                try {
                    await navigator.share({ text, url: window.location.href });
                } catch (e) { fallbackShare(text); }
            } else { fallbackShare(text); }
        }

        function fallbackShare(text) {
            navigator.clipboard?.writeText(text);
            const shareBtn = el('shareBtn');
            if (!shareBtn) return;
            const originalText = shareBtn.textContent;
            shareBtn.textContent = '✅ Copié!';
            showToast('Texte copié dans le presse-papiers');
            setTimeout(() => shareBtn.textContent = originalText, 2000);
        }

        // Easter eggs
        function addEasterEgg() {
            const egg = document.createElement('div');
            egg.className = 'easter-egg';
            egg.textContent = '💩';
            egg.style.left = Math.random() * window.innerWidth + 'px';
            egg.style.top = Math.random() * window.innerHeight + 'px';
            document.body.appendChild(egg);

            setTimeout(() => egg.remove(), 3000);
        }

        let clickCount = 0;
        title.addEventListener('click', () => {
            clickCount++;
            if (clickCount >= 5) {
                addEasterEgg();
                playSound(440, 200);
                clickCount = 0;
            }
        });

        // Reset function
        function resetAll() {
            if (confirm('Réinitialiser tous les paramètres et données ?')) {
                ['poopStats', 'poopHistory', 'poopAchievements'].forEach(key => localStorage.removeItem(key));
                stats = JSON.parse(JSON.stringify(DEFAULT_STATS));
                history = [];
                unlockedAchievements.clear();
                achievementNodes.forEach(node => setAchievementState(node.dataset.key, false));
                loadDefaults();
                updateStats();
                updateHistory();
                resetTimer('En attente');
                title.classList.add('shake');
                setTimeout(() => title.classList.remove('shake'), 500);
            }
        }

        // Load defaults
        function loadDefaults() {
            const defaults = DEFAULTS[currentMode] || DEFAULTS.basic;
            tj.value = defaults.tj;
            activeH.value = defaults.activeH;
            poopMin.value = defaults.poopMin;
            oneWaySec.value = defaults.oneWaySec;
            frequency.value = defaults.frequency ?? 2;

            // Set advanced inputs if they exist
            const productivityInput = el('productivity');
            if (productivityInput) {
                productivityInput.value = defaults.productivity ?? 85;
                updateProductivityDisplay();
            }

            const urgencySelect = el('urgency');
            if (urgencySelect) urgencySelect.value = defaults.urgency ?? 'normal';

            const teamInput = el('teamSize');
            if (teamInput) teamInput.value = defaults.teamSize ?? 1;

            const meetingInput = el('meetingCost');
            if (meetingInput) meetingInput.value = defaults.meetingCost ?? 0;

            compute();
        }

        // Event listeners
        themeToggle.addEventListener('click', toggleTheme);
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => switchMode(btn.dataset.mode));
        });

        [tj, activeH, poopMin, oneWaySec, frequency].forEach(input => input?.addEventListener('input', compute));

        el('saveBtn').addEventListener('click', saveCalculation);
        el('shareBtn').addEventListener('click', shareResults);
        el('resetBtn').addEventListener('click', resetAll);
        el('exportBtn').addEventListener('click', exportToCSV);
        el('clearHistoryBtn').addEventListener('click', () => {
            if (confirm('Vider l\'historique ?')) {
                history = [];
                localStorage.removeItem('poopHistory');
                updateHistory();
            }
        });
        timerStartBtn?.addEventListener('click', startTimer);
        timerPauseBtn?.addEventListener('click', pauseTimer);
        timerApplyBtn?.addEventListener('click', applyTimer);
        timerDisplay?.addEventListener('dblclick', () => {
            resetTimer('En attente');
            showToast('Minuteur remis à zéro');
        });

        // Initialize
        function init() {
            body.dataset.theme = theme;
            themeIcon.textContent = theme === 'dark' ? '🌙' : '☀️';
            themeText.textContent = theme === 'dark' ? 'Mode sombre' : 'Mode clair';

            loadDefaults();
            updateStats();
            updateHistory();
            evaluateAchievements({ silent: true });
            updateTimerUI('En attente');

            // Auto-save every calculation
            [tj, activeH, poopMin, oneWaySec, frequency].forEach(input => {
                input.addEventListener('change', () => {
                    if (input.value && compute().cost > 0) saveCalculation();
                });
            });
        }

        init();

        // Make functions available globally for onclick handlers
        window.loadFromHistory = loadFromHistory;
    })();
</script>
</body>
</html>



